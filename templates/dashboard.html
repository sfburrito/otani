{% extends "base.html" %}

{% block content %}
<div class="dashboard-container">
    <div class="flash-messages"></div>
    
    <div class="preferences-panel" data-aos="fade-up">
        <div class="section-header">
            <div class="header-title">
                <h3>Investment Preferences</h3>
            </div>
            <div class="header-actions">
                <button class="btn btn-primary" onclick="savePreferences()">
                    <i class="fas fa-save"></i> Save Preferences
                </button>
                <button class="btn btn-secondary" onclick="resetPreferences()">
                    <i class="fas fa-undo"></i> Reset
                </button>
            </div>
        </div>
        
        <div class="preferences-grid">
            <div class="custom-select-container">
                <label class="preference-label">Investment Stage</label>
                <div class="custom-select" tabindex="0" data-placeholder="Select stages">
                    <div class="select-trigger">
                        <span class="selected-text">Select stages</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="custom-options">
                        <label class="option-item">
                            <input type="checkbox" value="seed"> Seed
                        </label>
                        <label class="option-item">
                            <input type="checkbox" value="series_a"> Series A
                        </label>
                        <label class="option-item">
                            <input type="checkbox" value="series_b"> Series B
                        </label>
                        <label class="option-item">
                            <input type="checkbox" value="series_c"> Series C+
                        </label>
                        <label class="option-item">
                            <input type="checkbox" value="growth"> Growth
                        </label>
                        <label class="option-item">
                            <input type="checkbox" value="late_stage"> Late Stage
                        </label>
                    </div>
                </div>
            </div>

            <div class="custom-select-container">
                <label class="preference-label">Industry Sectors</label>
                <div class="custom-select" tabindex="0" data-placeholder="Select industries">
                    <div class="select-trigger">
                        <span class="selected-text">Select industries</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="custom-options">
                        <label class="option-item">
                            <input type="checkbox" value="ai_ml"> AI/Machine Learning
                        </label>
                        <label class="option-item">
                            <input type="checkbox" value="fintech"> Fintech
                        </label>
                        <label class="option-item">
                            <input type="checkbox" value="healthcare"> Healthcare/Biotech
                        </label>
                        <label class="option-item">
                            <input type="checkbox" value="saas"> Enterprise SaaS
                        </label>
                        <label class="option-item">
                            <input type="checkbox" value="consumer"> Consumer Tech
                        </label>
                        <label class="option-item">
                            <input type="checkbox" value="cleantech"> Cleantech/Sustainability
                        </label>
                        <label class="option-item">
                            <input type="checkbox" value="cybersecurity"> Cybersecurity
                        </label>
                        <label class="option-item">
                            <input type="checkbox" value="ecommerce"> E-commerce
                        </label>
                        <label class="option-item">
                            <input type="checkbox" value="edtech"> EdTech
                        </label>
                        <label class="option-item">
                            <input type="checkbox" value="gaming"> Gaming
                        </label>
                    </div>
                </div>
            </div>

            <div class="custom-select-container">
                <label class="preference-label">Geographic Focus</label>
                <div class="custom-select" tabindex="0" data-placeholder="Select regions">
                    <div class="select-trigger">
                        <span class="selected-text">Select regions</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="custom-options">
                        <label class="option-item">
                            <input type="checkbox" value="north_america"> North America
                        </label>
                        <label class="option-item">
                            <input type="checkbox" value="europe"> Europe
                        </label>
                        <label class="option-item">
                            <input type="checkbox" value="asia_pacific"> Asia-Pacific
                        </label>
                        <label class="option-item">
                            <input type="checkbox" value="latam"> Latin America
                        </label>
                        <label class="option-item">
                            <input type="checkbox" value="mea"> Middle East and Africa
                        </label>
                    </div>
                </div>
            </div>

            <div class="custom-select-container">
                <label class="preference-label">Investment Size</label>
                <div class="custom-select" tabindex="0" data-placeholder="Select investment sizes">
                    <div class="select-trigger">
                        <span class="selected-text">Select investment sizes</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="custom-options">
                        <label class="option-item">
                            <input type="checkbox" value="under_1m"> < $1M
                        </label>
                        <label class="option-item">
                            <input type="checkbox" value="1m_5m"> $1M - $5M
                        </label>
                        <label class="option-item">
                            <input type="checkbox" value="5m_20m"> $5M - $20M
                        </label>
                        <label class="option-item">
                            <input type="checkbox" value="20m_50m"> $20M - $50M
                        </label>
                        <label class="option-item">
                            <input type="checkbox" value="over_50m"> $50M+
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <div class="additional-preferences">
            <label class="preference-label" for="additionalPrefs">Additional Preferences</label>
            <textarea 
                id="additionalPrefs" 
                class="preference-textarea" 
                placeholder="Enter any additional preferences, criteria, or notes not covered above (e.g., specific technologies, founder backgrounds, impact goals). This information will help us better understand your unique investment strategy."
                rows="4"
            ></textarea>
        </div>
    </div>

    <div class="section-header">
        <div class="header-title">
            <h3>Your Companies</h3>
        </div>
        <div class="header-actions">
            <button class="btn btn-primary" onclick="openAddCompanyModal()">
                <i class="fas fa-plus"></i> Add Company
            </button>
        </div>
    </div>

    <div class="companies-section">
        <div class="search-bar">
            <i class="fas fa-search search-icon"></i>
            <input type="text" id="companySearch" placeholder="Search companies..." aria-label="Search companies">
        </div>

        <div class="table-responsive">
            <table class="companies-table" aria-label="Companies List">
                <thead>
                    <tr>
                        <th scope="col" class="sortable rating-col text-center" data-sort="rating" aria-sort="none">
                            <span>Rating</span>
                            <i class="fas fa-sort"></i>
                        </th>
                        <th scope="col" class="sortable text-center" data-sort="name" aria-sort="none">
                            <span>Company Name</span>
                            <i class="fas fa-sort"></i>
                        </th>
                        <th scope="col" class="sortable text-center" data-sort="industry" aria-sort="none">
                            <span>Industry</span>
                            <i class="fas fa-sort"></i>
                        </th>
                        <th scope="col" class="sortable text-center" data-sort="stage" aria-sort="none">
                            <span>Stage</span>
                            <i class="fas fa-sort"></i>
                        </th>
                        <th scope="col" class="icon-cell">Website</th>
                        <th scope="col" class="icon-cell">Email</th>
                        <th scope="col" class="description-col">Description</th>
                    </tr>
                </thead>
                <tbody id="companiesTableBody">
                    <!-- Table rows will be dynamically populated -->
                </tbody>
            </table>
        </div>

        <div class="pagination">
            <button class="btn btn-outline btn-sm" id="prevPage" aria-label="Previous page">
                <i class="fas fa-chevron-left"></i>
            </button>
            <span id="pageInfo">Page <span id="currentPage">1</span> of <span id="totalPages">1</span></span>
            <button class="btn btn-outline btn-sm" id="nextPage" aria-label="Next page">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>
</div>

<!-- Add Company Modal -->
<div id="addCompanyModal" class="modal">
    <div class="modal-overlay"></div>
    <div class="modal-container">
        <div class="modal-header">
            <h2>Add New Company</h2>
            <button class="modal-close close-modal" onclick="closeAddCompanyModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <form id="addCompanyForm" class="add-company-form">
                <div class="form-group">
                    <label for="name">Company Name *</label>
                    <input type="text" id="name" name="name" class="form-input" required>
                    <div class="error-message"></div>
                </div>

                <div class="form-group">
                    <label for="industry">Industry *</label>
                    <select id="industry" name="industry" class="form-input" required>
                        <option value="">Select Industry</option>
                        <option value="AI/ML">AI/Machine Learning</option>
                        <option value="Fintech">Fintech</option>
                        <option value="Healthcare">Healthcare/Biotech</option>
                        <option value="Enterprise">Enterprise SaaS</option>
                        <option value="Consumer">Consumer Tech</option>
                        <option value="Cleantech">Cleantech/Sustainability</option>
                        <option value="Cybersecurity">Cybersecurity</option>
                        <option value="E-commerce">E-commerce</option>
                    </select>
                    <div class="error-message"></div>
                </div>

                <div class="form-group">
                    <label for="stage">Stage *</label>
                    <select id="stage" name="stage" class="form-input" required>
                        <option value="">Select Stage</option>
                        <option value="Seed">Seed</option>
                        <option value="Series A">Series A</option>
                        <option value="Series B">Series B</option>
                        <option value="Series C">Series C</option>
                        <option value="Series D+">Series D+</option>
                    </select>
                    <div class="error-message"></div>
                </div>

                <div class="form-group">
                    <label for="website">Website</label>
                    <input type="url" id="website" name="website" class="form-input" placeholder="https://example.com">
                    <div class="error-message"></div>
                </div>

                <div class="form-group">
                    <label for="email">Contact Email</label>
                    <input type="email" id="email" name="email" class="form-input" placeholder="contact@example.com">
                    <div class="error-message"></div>
                </div>

                <div class="form-group">
                    <label for="description">Description</label>
                    <textarea id="description" name="description" class="form-input" rows="4"></textarea>
                    <div class="error-message"></div>
                </div>

                <div class="form-group">
                    <label for="rating">Rating</label>
                    <select id="rating" name="rating" class="form-input">
                        <option value="">Select Rating</option>
                        <option value="A">A - Excellent</option>
                        <option value="B">B - Good</option>
                        <option value="C">C - Fair</option>
                        <option value="D">D - Poor</option>
                    </select>
                    <div class="error-message"></div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-outline" onclick="closeAddCompanyModal()">Cancel</button>
            <button type="submit" class="btn btn-primary" form="addCompanyForm">Add Company</button>
        </div>
    </div>
</div>

{% include 'company_details_modal.html' %}

<script src="{{ url_for('static', filename='js/company_details.js') }}"></script>
<script src="{{ url_for('static', filename='js/add_company.js') }}"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    try {
        // Initialize preferences from server data with safe defaults
        const serverPreferences = {
            investment_stages: {{ preferences.investment_stages|tojson|safe if preferences.investment_stages else '[]' }},
            industry_sectors: {{ preferences.industry_sectors|tojson|safe if preferences.industry_sectors else '[]' }},
            geographic_focus: {{ preferences.geographic_focus|tojson|safe if preferences.geographic_focus else '[]' }},
            investment_sizes: {{ preferences.investment_sizes|tojson|safe if preferences.investment_sizes else '[]' }},
            additional_preferences: {{ preferences.additional_preferences|tojson|safe if preferences.additional_preferences else '""' }}
        };

        // Initialize companies list
        const companies = {{ companies|tojson|safe }};
        console.log('Companies:', companies);
        renderCompanies(companies);

        // Set initial values for each preference
        setSelectedOptions('Select stages', serverPreferences.investment_stages);
        setSelectedOptions('Select industries', serverPreferences.industry_sectors);
        setSelectedOptions('Select regions', serverPreferences.geographic_focus);
        setSelectedOptions('Select investment sizes', serverPreferences.investment_sizes);
        
        // Set additional preferences
        document.getElementById('additionalPrefs').value = serverPreferences.additional_preferences;

    } catch (error) {
        console.error('Error initializing dashboard:', error);
    }
});

// Render companies in the table
function renderCompanies(companies) {
    console.log('Rendering companies:', companies);
    const tbody = document.getElementById('companiesTableBody');
    tbody.innerHTML = '';

    if (!companies || companies.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td colspan="7" class="text-center">
                <div class="empty-state">
                    <i class="fas fa-folder-open"></i>
                    <p>No companies added yet</p>
                </div>
            </td>
        `;
        tbody.appendChild(tr);
        return;
    }

    companies.forEach(company => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td class="text-center">
                <span class="rating-badge rating-${company.rating?.toLowerCase() || 'none'}">${company.rating || '-'}</span>
            </td>
            <td class="text-center">${company.name || '-'}</td>
            <td class="text-center">${company.industry || '-'}</td>
            <td class="text-center">${company.stage || '-'}</td>
            <td class="text-center">
                ${company.website ? `
                    <a href="${company.website}" target="_blank" rel="noopener noreferrer" class="icon-link">
                        <i class="fas fa-globe"></i>
                    </a>
                ` : '-'}
            </td>
            <td class="text-center">
                ${company.email ? `
                    <a href="mailto:${company.email}" class="icon-link">
                        <i class="fas fa-envelope"></i>
                    </a>
                ` : '-'}
            </td>
            <td class="description-cell">
                ${company.description || '-'}
            </td>
        `;
        tbody.appendChild(tr);
    });
}

function updateSelectedText(select) {
    const selectedOptions = Array.from(select.querySelectorAll('input[type="checkbox"]:checked'))
        .map(checkbox => checkbox.parentElement.textContent.trim());
    const selectedText = select.querySelector('.selected-text');
    const placeholder = select.dataset.placeholder;
    
    if (selectedText) {
        selectedText.textContent = selectedOptions.length > 0 ? selectedOptions.join(', ') : placeholder;
    }
}

function setSelectedOptions(selectPlaceholder, selectedValues) {
    if (!selectedValues) return;
    
    const select = document.querySelector(`.custom-select[data-placeholder="${selectPlaceholder}"]`);
    if (select) {
        select.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            checkbox.checked = selectedValues.includes(checkbox.value);
        });
        updateSelectedText(select);
    }
}

function savePreferences() {
    const stages = getSelectedValues('Select stages');
    const sectors = getSelectedValues('Select industries');
    const regions = getSelectedValues('Select regions');
    const sizes = getSelectedValues('Select investment sizes');
    const additionalPrefs = document.getElementById('additionalPrefs');
    const additional = additionalPrefs ? additionalPrefs.value : '';

    const preferences = {
        investment_stages: stages,
        industry_sectors: sectors,
        geographic_focus: regions,
        investment_sizes: sizes,
        additional_preferences: additional
    };
    
    console.log('Saving preferences:', preferences);
    
    fetch('/api/preferences', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(preferences)
    })
    .then(response => response.json())
    .then(data => {
        showSuccess('Preferences saved successfully');
        loadPreferences(); // Reload to verify
    })
    .catch(error => {
        console.error('Error:', error);
        showError('Failed to save preferences');
    });
}

function getSelectedValues(placeholder) {
    const select = document.querySelector(`.custom-select[data-placeholder="${placeholder}"]`);
    if (!select) return [];
    
    return Array.from(select.querySelectorAll('input[type="checkbox"]:checked'))
        .map(checkbox => checkbox.value);
}

function openAddCompanyModal() {
    const modal = document.getElementById('addCompanyModal');
    modal.style.display = 'block';
    document.body.style.overflow = 'hidden';
}

function closeAddCompanyModal() {
    const modal = document.getElementById('addCompanyModal');
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
}

function resetPreferences() {
    document.querySelectorAll('.custom-select').forEach(select => {
        const selectedText = select.querySelector('.selected-text');
        const options = select.querySelectorAll('input');
        
        options.forEach(option => option.checked = false);
        selectedText.textContent = select.getAttribute('data-placeholder');
    });

    const textarea = document.getElementById('additionalPrefs');
    textarea.value = '';
    textarea.style.height = 'auto';
}
</script>
{% endblock %}
