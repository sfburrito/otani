{% extends "base.html" %}

{% block content %}
<div class="dashboard-container">
    <div class="flash-messages"></div>
    
    <div class="preferences-panel" data-aos="fade-up">
        <div class="section-header">
            <div class="header-title">
                <h3>Investment Preferences</h3>
            </div>
            <div class="header-actions">
                <button class="btn btn-primary" onclick="savePreferences()">
                    <i class="fas fa-save"></i> Save Preferences
                </button>
                <button class="btn btn-secondary" onclick="resetPreferences()">
                    <i class="fas fa-undo"></i> Reset
                </button>
            </div>
        </div>
        
        <div class="preferences-grid">
            <div class="custom-select-container">
                <label class="preference-label">Investment Stage</label>
                <div class="custom-select" tabindex="0" data-placeholder="Select stages">
                    <div class="select-trigger">
                        <span class="selected-text">Select stages</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="custom-options">
                        <label class="option-item">
                            <input type="checkbox" value="seed"> Seed
                        </label>
                        <label class="option-item">
                            <input type="checkbox" value="series_a"> Series A
                        </label>
                        <label class="option-item">
                            <input type="checkbox" value="series_b"> Series B
                        </label>
                        <label class="option-item">
                            <input type="checkbox" value="series_c"> Series C+
                        </label>
                        <label class="option-item">
                            <input type="checkbox" value="growth"> Growth
                        </label>
                        <label class="option-item">
                            <input type="checkbox" value="late_stage"> Late Stage
                        </label>
                    </div>
                </div>
            </div>

            <div class="custom-select-container">
                <label class="preference-label">Industry Sectors</label>
                <div class="custom-select" tabindex="0" data-placeholder="Select industries">
                    <div class="select-trigger">
                        <span class="selected-text">Select industries</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="custom-options">
                        <label class="option-item">
                            <input type="checkbox" value="ai_ml"> AI/Machine Learning
                        </label>
                        <label class="option-item">
                            <input type="checkbox" value="fintech"> Fintech
                        </label>
                        <label class="option-item">
                            <input type="checkbox" value="healthcare"> Healthcare/Biotech
                        </label>
                        <label class="option-item">
                            <input type="checkbox" value="saas"> Enterprise SaaS
                        </label>
                        <label class="option-item">
                            <input type="checkbox" value="consumer"> Consumer Tech
                        </label>
                        <label class="option-item">
                            <input type="checkbox" value="cleantech"> Cleantech/Sustainability
                        </label>
                        <label class="option-item">
                            <input type="checkbox" value="cybersecurity"> Cybersecurity
                        </label>
                        <label class="option-item">
                            <input type="checkbox" value="ecommerce"> E-commerce
                        </label>
                        <label class="option-item">
                            <input type="checkbox" value="edtech"> EdTech
                        </label>
                        <label class="option-item">
                            <input type="checkbox" value="gaming"> Gaming
                        </label>
                    </div>
                </div>
            </div>

            <div class="custom-select-container">
                <label class="preference-label">Geographic Focus</label>
                <div class="custom-select" tabindex="0" data-placeholder="Select regions">
                    <div class="select-trigger">
                        <span class="selected-text">Select regions</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="custom-options">
                        <label class="option-item">
                            <input type="checkbox" value="north_america"> North America
                        </label>
                        <label class="option-item">
                            <input type="checkbox" value="europe"> Europe
                        </label>
                        <label class="option-item">
                            <input type="checkbox" value="asia_pacific"> Asia-Pacific
                        </label>
                        <label class="option-item">
                            <input type="checkbox" value="latam"> Latin America
                        </label>
                        <label class="option-item">
                            <input type="checkbox" value="mea"> Middle East and Africa
                        </label>
                    </div>
                </div>
            </div>

            <div class="custom-select-container">
                <label class="preference-label">Investment Size</label>
                <div class="custom-select" tabindex="0" data-placeholder="Select investment sizes">
                    <div class="select-trigger">
                        <span class="selected-text">Select investment sizes</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="custom-options">
                        <label class="option-item">
                            <input type="checkbox" value="under_1m"> < $1M
                        </label>
                        <label class="option-item">
                            <input type="checkbox" value="1m_5m"> $1M - $5M
                        </label>
                        <label class="option-item">
                            <input type="checkbox" value="5m_20m"> $5M - $20M
                        </label>
                        <label class="option-item">
                            <input type="checkbox" value="20m_50m"> $20M - $50M
                        </label>
                        <label class="option-item">
                            <input type="checkbox" value="over_50m"> $50M+
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <div class="additional-preferences">
            <label class="preference-label" for="additionalPrefs">Additional Preferences</label>
            <textarea 
                id="additionalPrefs" 
                class="preference-textarea" 
                placeholder="Enter any additional preferences, criteria, or notes not covered above (e.g., specific technologies, founder backgrounds, impact goals). This information will help us better understand your unique investment strategy."
                rows="4"
            ></textarea>
        </div>
    </div>

    <div class="section-header">
        <div class="header-title">
            <h3>Your Companies</h3>
        </div>
        <div class="header-actions">
            <button class="btn btn-primary" onclick="openModal()">
                <i class="fas fa-plus"></i> Add Company
            </button>
        </div>
    </div>

    <div class="companies-section">
        <div class="search-bar">
            <i class="fas fa-search search-icon"></i>
            <input type="text" id="companySearch" placeholder="Search companies..." aria-label="Search companies">
        </div>

        <div class="table-responsive">
            <table class="companies-table" aria-label="Companies List">
                <thead>
                    <tr>
                        <th scope="col" class="sortable rating-col text-center" data-sort="rating" aria-sort="none">
                            <span>Rating</span>
                            <i class="fas fa-sort"></i>
                        </th>
                        <th scope="col" class="sortable text-center" data-sort="name" aria-sort="none">
                            <span>Company Name</span>
                            <i class="fas fa-sort"></i>
                        </th>
                        <th scope="col" class="sortable text-center" data-sort="industry" aria-sort="none">
                            <span>Industry</span>
                            <i class="fas fa-sort"></i>
                        </th>
                        <th scope="col" class="sortable text-center" data-sort="stage" aria-sort="none">
                            <span>Stage</span>
                            <i class="fas fa-sort"></i>
                        </th>
                        <th scope="col" class="icon-cell">Website</th>
                        <th scope="col" class="icon-cell">Email</th>
                        <th scope="col" class="description-col">Description</th>
                    </tr>
                </thead>
                <tbody id="companiesTableBody">
                    <!-- Table rows will be dynamically populated -->
                </tbody>
            </table>
        </div>

        <div class="pagination">
            <button class="btn btn-outline btn-sm" id="prevPage" aria-label="Previous page">
                <i class="fas fa-chevron-left"></i>
            </button>
            <span id="pageInfo">Page <span id="currentPage">1</span> of <span id="totalPages">1</span></span>
            <button class="btn btn-outline btn-sm" id="nextPage" aria-label="Next page">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>
</div>

<!-- Add Company Modal -->
<div id="addCompanyModal" class="modal">
    <div class="modal-overlay"></div>
    <div class="modal-container">
        <div class="modal-header">
            <h2>Add New Company</h2>
            <button class="modal-close" onclick="closeModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-content">
            <form id="addCompanyForm" class="add-company-form">
                <div class="company-details-grid">
                    <!-- Basic Information -->
                    <div class="detail-section">
                        <h3>Basic Information</h3>
                        <div class="info-grid">
                            <div class="info-item">
                                <label>Company Name *</label>
                                <input type="text" class="form-input" id="name" name="name" required>
                            </div>
                            <div class="info-item">
                                <label>Industry *</label>
                                <select class="form-input" id="industry" name="industry" required>
                                    <option value="">Select Industry</option>
                                    <option value="Software">Software</option>
                                    <option value="Hardware">Hardware</option>
                                    <option value="AI/ML">AI/ML</option>
                                    <option value="Fintech">Fintech</option>
                                    <option value="Healthcare">Healthcare</option>
                                    <option value="E-commerce">E-commerce</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="info-item">
                                <label>Stage *</label>
                                <select class="form-input" id="stage" name="stage" required>
                                    <option value="">Select Stage</option>
                                    <option value="Seed">Seed</option>
                                    <option value="Series A">Series A</option>
                                    <option value="Series B">Series B</option>
                                    <option value="Series C">Series C</option>
                                    <option value="Series D+">Series D+</option>
                                </select>
                            </div>
                            <div class="info-item">
                                <label>Investment Amount *</label>
                                <input type="number" class="form-input" id="investment_amount" name="investment_amount" required>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Additional Details -->
                    <div class="detail-section">
                        <h3>Additional Details</h3>
                        <div class="info-grid">
                            <div class="info-item">
                                <label>Website</label>
                                <input type="url" class="form-input" id="website" name="website">
                            </div>
                            <div class="info-item">
                                <label>Location</label>
                                <input type="text" class="form-input" id="location" name="location">
                            </div>
                            <div class="info-item full-width">
                                <label>Description</label>
                                <textarea class="form-input" id="description" name="description" rows="3"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Company</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% include 'company_details_modal.html' %}

<script src="{{ url_for('static', filename='js/company_details.js') }}"></script>
<script src="{{ url_for('static', filename='js/add_company.js') }}"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize preferences from server data
    const serverPreferences = {
        investment_stages: {{ investment_stages|default([])|tojson|safe }},
        geographic_focus: {{ geographic_focus|default([])|tojson|safe }},
        additional_preferences: {{ additional_preferences|default('')|tojson|safe }}
    };

    // Initialize dropdowns
    const customSelects = document.querySelectorAll('.custom-select');
    customSelects.forEach(select => {
        const trigger = select.querySelector('.select-trigger');
        
        trigger.addEventListener('click', (e) => {
            e.stopPropagation();
            customSelects.forEach(otherSelect => {
                if (otherSelect !== select) {
                    otherSelect.classList.remove('active');
                }
            });
            select.classList.toggle('active');
        });

        // Set initial values from server data
        if (select.getAttribute('data-placeholder') === 'Select stages') {
            select.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = serverPreferences.investment_stages.includes(checkbox.value);
            });
            updateSelectedText(select);
        } else if (select.getAttribute('data-placeholder') === 'Select regions') {
            select.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = serverPreferences.geographic_focus.includes(checkbox.value);
            });
            updateSelectedText(select);
        }
    });

    // Set additional preferences
    const additionalPrefs = document.getElementById('additionalPrefs');
    if (additionalPrefs && serverPreferences.additional_preferences) {
        additionalPrefs.value = serverPreferences.additional_preferences;
    }

    // Close dropdowns when clicking outside
    document.addEventListener('click', () => {
        customSelects.forEach(select => select.classList.remove('active'));
    });

    // Initialize companies table
    loadCompanies();
});

function updateSelectedText(select) {
    const selectedOptions = Array.from(select.querySelectorAll('input[type="checkbox"]:checked'))
        .map(checkbox => checkbox.parentElement.textContent.trim());
    const selectedText = select.querySelector('.selected-text');
    selectedText.textContent = selectedOptions.length > 0 ? selectedOptions.join(', ') : select.getAttribute('data-placeholder');
}

function loadCompanies() {
    const companies = [
        {
            name: 'TechCorp',
            industry: 'Software',
            stage: 'Series A',
            website: 'https://techcorp.com',
            email: 'contact@techcorp.com',
            description: 'Leading provider of enterprise software solutions...',
            rating: 'A'
        },
        // Add more sample data
    ];

    renderCompanies(companies);
}

function renderCompanies(companies) {
    const tbody = document.getElementById('companiesTableBody');
    tbody.innerHTML = '';

    companies.forEach(company => {
        const row = document.createElement('tr');
        row.style.cursor = 'pointer';
        row.addEventListener('click', () => openCompanyDetails(company.name));
        row.innerHTML = `
            <td class="rating-col text-center" data-label="Rating">
                ${company.rating ? `<span class="rating-badge rating-${company.rating.toLowerCase()}">${company.rating}</span>` : ''}
            </td>
            <td class="text-center" data-label="Company Name">${company.name}</td>
            <td class="text-center" data-label="Industry">${company.industry}</td>
            <td class="text-center" data-label="Stage">${company.stage}</td>
            <td class="icon-cell" data-label="Website">
                ${company.website ? `
                    <a href="${company.website}" target="_blank" rel="noopener noreferrer" aria-label="Visit ${company.name} website">
                        <i class="fas fa-globe"></i>
                    </a>
                ` : ''}
            </td>
            <td class="icon-cell" data-label="Email">
                ${company.email ? `
                    <a href="mailto:${company.email}" aria-label="Email ${company.name}">
                        <i class="fas fa-envelope"></i>
                    </a>
                ` : ''}
            </td>
            <td class="description-cell" data-label="Description">
                <div class="description-content">
                    <span class="description-text">${company.description}</span>
                    <button class="read-more-btn" aria-expanded="false">Read More</button>
                </div>
            </td>
        `;
        
        const readMoreBtn = row.querySelector('.read-more-btn');
        const descriptionText = row.querySelector('.description-text');
        
        if (descriptionText.scrollHeight > descriptionText.clientHeight) {
            readMoreBtn.style.display = 'inline-block';
            readMoreBtn.addEventListener('click', () => {
                const isExpanded = readMoreBtn.getAttribute('aria-expanded') === 'true';
                descriptionText.style.maxHeight = isExpanded ? null : descriptionText.scrollHeight + 'px';
                readMoreBtn.textContent = isExpanded ? 'Read More' : 'Show Less';
                readMoreBtn.setAttribute('aria-expanded', !isExpanded);
            });
        } else {
            readMoreBtn.style.display = 'none';
        }

        tbody.appendChild(row);
    });
}

function savePreferences() {
    const investmentStages = [];
    const geographicFocus = [];
    
    document.querySelectorAll('.custom-select[data-placeholder="Select stages"] input:checked').forEach(checkbox => {
        investmentStages.push(checkbox.value);
    });
    
    document.querySelectorAll('.custom-select[data-placeholder="Select regions"] input:checked').forEach(checkbox => {
        geographicFocus.push(checkbox.value);
    });
    
    const additionalPrefs = document.getElementById('additionalPrefs').value;
    
    const data = {
        investment_stages: investmentStages,
        geographic_focus: geographicFocus,
        additional_preferences: additionalPrefs
    };
    
    const saveButton = document.querySelector('button.btn-primary');
    const originalText = saveButton.innerHTML;
    saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    saveButton.disabled = true;
    
    fetch('/api/preferences', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            throw new Error(data.error);
        }
        const flashContainer = document.querySelector('.flash-messages');
        const flashMessage = document.createElement('div');
        flashMessage.className = 'flash-message success';
        flashMessage.textContent = 'Preferences saved successfully';
        flashContainer.appendChild(flashMessage);
        
        setTimeout(() => {
            flashMessage.remove();
        }, 3000);
    })
    .catch(error => {
        const flashContainer = document.querySelector('.flash-messages');
        const flashMessage = document.createElement('div');
        flashMessage.className = 'flash-message error';
        flashMessage.textContent = 'Failed to save preferences';
        flashContainer.appendChild(flashMessage);
        
        setTimeout(() => {
            flashMessage.remove();
        }, 3000);
    })
    .finally(() => {
        saveButton.innerHTML = originalText;
        saveButton.disabled = false;
    });
}

function loadPreferences() {
    fetch('/api/preferences')
        .then(response => response.json())
        .then(data => {
            document.querySelectorAll('.custom-select[data-placeholder="Select stages"] input[type="checkbox"]').forEach(checkbox => {
                if (data.investment_stages.includes(checkbox.value)) {
                    checkbox.checked = true;
                }
            });
            updateSelectedText(document.querySelector('.custom-select[data-placeholder="Select stages"]'));
            
            document.querySelectorAll('.custom-select[data-placeholder="Select regions"] input[type="checkbox"]').forEach(checkbox => {
                if (data.geographic_focus.includes(checkbox.value)) {
                    checkbox.checked = true;
                }
            });
            updateSelectedText(document.querySelector('.custom-select[data-placeholder="Select regions"]'));
            
            if (data.additional_preferences) {
                document.getElementById('additionalPrefs').value = data.additional_preferences;
            }
        })
        .catch(error => {
            console.error('Error loading preferences:', error);
        });
}

document.addEventListener('DOMContentLoaded', function() {
    loadPreferences();
});

function resetPreferences() {
    document.querySelectorAll('.custom-select').forEach(select => {
        const selectedText = select.querySelector('.selected-text');
        const options = select.querySelectorAll('input');
        
        options.forEach(option => option.checked = false);
        selectedText.textContent = select.getAttribute('data-placeholder');
    });

    const textarea = document.getElementById('additionalPrefs');
    textarea.value = '';
    textarea.style.height = 'auto';
}

function openModal() {
    const modal = document.getElementById('addCompanyModal');
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

function closeModal() {
    const modal = document.getElementById('addCompanyModal');
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
    document.getElementById('addCompanyForm').reset();
}

document.addEventListener('click', function(event) {
    const modal = document.getElementById('addCompanyModal');
    if (event.target.classList.contains('modal-overlay')) {
        closeModal();
    }
});

window.onclick = function(event) {
    if (event.target.classList.contains('modal')) {
        closeModal();
    }
}
</script>
{% endblock %}
