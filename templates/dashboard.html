{% extends "base.html" %}

{% block content %}
<div class="dashboard-container">
    <div class="preferences-panel" data-aos="fade-up">
        <div class="section-header">
            <div class="header-title">
                <h3>Investment Preferences</h3>
            </div>
            <div class="header-actions">
                <button class="btn btn-outline" onclick="resetPreferences()">Reset</button>
                <button class="btn btn-primary" onclick="savePreferences()">Save Preferences</button>
            </div>
        </div>
        
        <div class="preferences-grid">
            <div class="custom-select-container">
                <label class="preference-label">Investment Stage</label>
                <div class="custom-select" tabindex="0" data-placeholder="Select stages">
                    <div class="select-trigger">
                        <span class="selected-text">Select stages</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="custom-options">
                        <label class="option-item">
                            <input type="checkbox" value="seed"> Seed
                        </label>
                        <label class="option-item">
                            <input type="checkbox" value="series_a"> Series A
                        </label>
                        <label class="option-item">
                            <input type="checkbox" value="series_b"> Series B
                        </label>
                        <label class="option-item">
                            <input type="checkbox" value="series_c"> Series C+
                        </label>
                        <label class="option-item">
                            <input type="checkbox" value="growth"> Growth
                        </label>
                        <label class="option-item">
                            <input type="checkbox" value="late_stage"> Late Stage
                        </label>
                    </div>
                </div>
            </div>

            <div class="custom-select-container">
                <label class="preference-label">Industry Sectors</label>
                <div class="custom-select" tabindex="0" data-placeholder="Select industries">
                    <div class="select-trigger">
                        <span class="selected-text">Select industries</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="custom-options">
                        <label class="option-item">
                            <input type="checkbox" value="ai_ml"> AI/Machine Learning
                        </label>
                        <label class="option-item">
                            <input type="checkbox" value="fintech"> Fintech
                        </label>
                        <label class="option-item">
                            <input type="checkbox" value="healthcare"> Healthcare/Biotech
                        </label>
                        <label class="option-item">
                            <input type="checkbox" value="saas"> Enterprise SaaS
                        </label>
                        <label class="option-item">
                            <input type="checkbox" value="consumer"> Consumer Tech
                        </label>
                        <label class="option-item">
                            <input type="checkbox" value="cleantech"> Cleantech/Sustainability
                        </label>
                        <label class="option-item">
                            <input type="checkbox" value="cybersecurity"> Cybersecurity
                        </label>
                        <label class="option-item">
                            <input type="checkbox" value="ecommerce"> E-commerce
                        </label>
                        <label class="option-item">
                            <input type="checkbox" value="edtech"> EdTech
                        </label>
                        <label class="option-item">
                            <input type="checkbox" value="gaming"> Gaming
                        </label>
                    </div>
                </div>
            </div>

            <div class="custom-select-container">
                <label class="preference-label">Geographic Focus</label>
                <div class="custom-select" tabindex="0" data-placeholder="Select regions">
                    <div class="select-trigger">
                        <span class="selected-text">Select regions</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="custom-options">
                        <label class="option-item">
                            <input type="checkbox" value="north_america"> North America
                        </label>
                        <label class="option-item">
                            <input type="checkbox" value="europe"> Europe
                        </label>
                        <label class="option-item">
                            <input type="checkbox" value="asia_pacific"> Asia-Pacific
                        </label>
                        <label class="option-item">
                            <input type="checkbox" value="latam"> Latin America
                        </label>
                        <label class="option-item">
                            <input type="checkbox" value="mea"> Middle East and Africa
                        </label>
                    </div>
                </div>
            </div>

            <div class="custom-select-container">
                <label class="preference-label">Investment Size</label>
                <div class="custom-select" tabindex="0" data-placeholder="Select investment sizes">
                    <div class="select-trigger">
                        <span class="selected-text">Select investment sizes</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="custom-options">
                        <label class="option-item">
                            <input type="checkbox" value="under_1m"> < $1M
                        </label>
                        <label class="option-item">
                            <input type="checkbox" value="1m_5m"> $1M - $5M
                        </label>
                        <label class="option-item">
                            <input type="checkbox" value="5m_20m"> $5M - $20M
                        </label>
                        <label class="option-item">
                            <input type="checkbox" value="20m_50m"> $20M - $50M
                        </label>
                        <label class="option-item">
                            <input type="checkbox" value="over_50m"> $50M+
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <div class="additional-preferences">
            <label class="preference-label" for="additionalPrefs">Additional Preferences</label>
            <textarea 
                id="additionalPrefs" 
                class="preference-textarea" 
                placeholder="Enter any additional preferences, criteria, or notes not covered above (e.g., specific technologies, founder backgrounds, impact goals). This information will help us better understand your unique investment strategy."
                rows="4"
            ></textarea>
        </div>
    </div>

    <div class="section-header">
        <div class="header-title">
            <h3>Your Companies</h3>
        </div>
        <div class="header-actions">
            <button class="btn btn-primary" onclick="openModal()">
                <i class="fas fa-plus"></i> Add Company
            </button>
        </div>
    </div>

    <div class="companies-section">
        <div class="search-bar">
            <i class="fas fa-search search-icon"></i>
            <input type="text" id="companySearch" placeholder="Search companies..." aria-label="Search companies">
        </div>

        <div class="table-responsive">
            <table class="companies-table" aria-label="Companies List">
                <thead>
                    <tr>
                        <th scope="col" class="sortable rating-col text-center" data-sort="rating" aria-sort="none">
                            <span>Rating</span>
                            <i class="fas fa-sort"></i>
                        </th>
                        <th scope="col" class="sortable text-center" data-sort="name" aria-sort="none">
                            <span>Company Name</span>
                            <i class="fas fa-sort"></i>
                        </th>
                        <th scope="col" class="sortable text-center" data-sort="industry" aria-sort="none">
                            <span>Industry</span>
                            <i class="fas fa-sort"></i>
                        </th>
                        <th scope="col" class="sortable text-center" data-sort="stage" aria-sort="none">
                            <span>Stage</span>
                            <i class="fas fa-sort"></i>
                        </th>
                        <th scope="col" class="icon-cell">Website</th>
                        <th scope="col" class="icon-cell">Email</th>
                        <th scope="col" class="description-col">Description</th>
                    </tr>
                </thead>
                <tbody id="companiesTableBody">
                    <!-- Table rows will be dynamically populated -->
                </tbody>
            </table>
        </div>

        <div class="pagination">
            <button class="btn btn-outline btn-sm" id="prevPage" aria-label="Previous page">
                <i class="fas fa-chevron-left"></i>
            </button>
            <span id="pageInfo">Page <span id="currentPage">1</span> of <span id="totalPages">1</span></span>
            <button class="btn btn-outline btn-sm" id="nextPage" aria-label="Next page">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>
</div>

<!-- Add Company Modal -->
<div id="addCompanyModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Add New Company</h3>
            <button type="button" class="close-modal" onclick="closeModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form class="add-company-form" method="POST" action="{{ url_for('add_company') }}">
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label" for="name">Company Name</label>
                    <input type="text" class="form-input" id="name" name="name" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="industry">Industry</label>
                    <input type="text" class="form-input" id="industry" name="industry">
                </div>
                <div class="form-group">
                    <label class="form-label" for="stage">Stage</label>
                    <select class="form-input" id="stage" name="stage">
                        <option value="Seed">Seed</option>
                        <option value="Series A">Series A</option>
                        <option value="Series B">Series B</option>
                        <option value="Series C">Series C+</option>
                        <option value="Growth">Growth</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="website">Website</label>
                    <input type="url" class="form-input" id="website" name="website">
                </div>
            </div>
            <div class="form-group">
                <label class="form-label" for="description">Description</label>
                <textarea class="form-input" id="description" name="description" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label class="form-label" for="contact_email">Contact Email</label>
                <input type="email" class="form-input" id="contact_email" name="contact_email">
            </div>
            <div class="form-group">
                <label class="form-label" for="notes">Notes</label>
                <textarea class="form-input" id="notes" name="notes" rows="3"></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Company</button>
            </div>
        </form>
    </div>
</div>

{% include 'company_details_modal.html' %}

<script src="{{ url_for('static', filename='js/company_details.js') }}"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize custom dropdowns
    const customSelects = document.querySelectorAll('.custom-select');
    
    customSelects.forEach(select => {
        const trigger = select.querySelector('.select-trigger');
        const selectedText = select.querySelector('.selected-text');
        const options = select.querySelectorAll('.option-item input');
        const placeholder = select.dataset.placeholder;
        
        // Handle click outside
        document.addEventListener('click', (e) => {
            if (!select.contains(e.target)) {
                select.classList.remove('open');
            }
        });
        
        // Toggle dropdown
        trigger.addEventListener('click', (e) => {
            e.stopPropagation();
            const isOpen = select.classList.contains('open');
            
            // Close all other dropdowns
            customSelects.forEach(s => s.classList.remove('open'));
            
            // Toggle current dropdown
            select.classList.toggle('open', !isOpen);
        });
        
        // Handle option selection
        options.forEach(option => {
            option.addEventListener('change', () => {
                const selectedOptions = Array.from(options)
                    .filter(opt => opt.checked)
                    .map(opt => opt.parentElement.textContent.trim());
                
                if (selectedOptions.length > 0) {
                    selectedText.textContent = selectedOptions.join(', ');
                } else {
                    selectedText.textContent = placeholder;
                }
            });
        });
        
        // Handle keyboard navigation
        select.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                select.classList.toggle('open');
            } else if (e.key === 'Escape') {
                select.classList.remove('open');
            }
        });
    });

    // Initialize auto-expanding textarea
    const textarea = document.getElementById('additionalPrefs');
    textarea.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
    });
    
    // Initialize AOS
    AOS.init({
        duration: 800,
        once: true
    });

    // Table sorting functionality
    const sortableHeaders = document.querySelectorAll('.sortable');
    sortableHeaders.forEach(header => {
        header.addEventListener('click', () => {
            const currentSort = header.getAttribute('aria-sort');
            
            // Reset all other headers
            sortableHeaders.forEach(h => {
                h.setAttribute('aria-sort', 'none');
                h.querySelector('i').className = 'fas fa-sort';
            });
            
            // Set new sort direction
            let newSort = 'ascending';
            if (currentSort === 'ascending') {
                newSort = 'descending';
            }
            
            header.setAttribute('aria-sort', newSort);
            header.querySelector('i').className = `fas fa-sort-${newSort === 'ascending' ? 'up' : 'down'}`;
            
            sortTable(header.dataset.sort, newSort === 'ascending');
        });
    });

    // Search functionality
    const searchInput = document.getElementById('companySearch');
    let searchTimeout;
    searchInput.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            filterCompanies(searchInput.value.toLowerCase());
        }, 300);
    });

    // Initialize table data
    loadCompanies();
});

function loadCompanies() {
    // Sample data - replace with actual API call
    const companies = [
        {
            name: 'TechCorp',
            industry: 'Software',
            stage: 'Series A',
            website: 'https://techcorp.com',
            email: 'contact@techcorp.com',
            description: 'Leading provider of enterprise software solutions...',
            rating: 'A'
        },
        // Add more sample data
    ];

    renderCompanies(companies);
}

function renderCompanies(companies) {
    const tbody = document.getElementById('companiesTableBody');
    tbody.innerHTML = '';

    companies.forEach(company => {
        const row = document.createElement('tr');
        row.style.cursor = 'pointer';
        row.addEventListener('click', () => openCompanyDetails(company.name));
        row.innerHTML = `
            <td class="rating-col text-center" data-label="Rating">
                ${company.rating ? `<span class="rating-badge rating-${company.rating.toLowerCase()}">${company.rating}</span>` : ''}
            </td>
            <td class="text-center" data-label="Company Name">${company.name}</td>
            <td class="text-center" data-label="Industry">${company.industry}</td>
            <td class="text-center" data-label="Stage">${company.stage}</td>
            <td class="icon-cell" data-label="Website">
                ${company.website ? `
                    <a href="${company.website}" target="_blank" rel="noopener noreferrer" aria-label="Visit ${company.name} website">
                        <i class="fas fa-globe"></i>
                    </a>
                ` : ''}
            </td>
            <td class="icon-cell" data-label="Email">
                ${company.email ? `
                    <a href="mailto:${company.email}" aria-label="Email ${company.name}">
                        <i class="fas fa-envelope"></i>
                    </a>
                ` : ''}
            </td>
            <td class="description-cell" data-label="Description">
                <div class="description-content">
                    <span class="description-text">${company.description}</span>
                    <button class="read-more-btn" aria-expanded="false">Read More</button>
                </div>
            </td>
        `;
        
        // Add read more functionality
        const readMoreBtn = row.querySelector('.read-more-btn');
        const descriptionText = row.querySelector('.description-text');
        
        if (descriptionText.scrollHeight > descriptionText.clientHeight) {
            readMoreBtn.style.display = 'inline-block';
            readMoreBtn.addEventListener('click', () => {
                const isExpanded = readMoreBtn.getAttribute('aria-expanded') === 'true';
                descriptionText.style.maxHeight = isExpanded ? null : descriptionText.scrollHeight + 'px';
                readMoreBtn.textContent = isExpanded ? 'Read More' : 'Show Less';
                readMoreBtn.setAttribute('aria-expanded', !isExpanded);
            });
        } else {
            readMoreBtn.style.display = 'none';
        }

        tbody.appendChild(row);
    });
}

function sortTable(column, ascending) {
    const tbody = document.getElementById('companiesTableBody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    rows.sort((a, b) => {
        const aValue = a.children[getColumnIndex(column)].textContent;
        const bValue = b.children[getColumnIndex(column)].textContent;
        return ascending ? aValue.localeCompare(bValue) : bValue.localeCompare(aValue);
    });
    
    tbody.innerHTML = '';
    rows.forEach(row => tbody.appendChild(row));
}

function getColumnIndex(column) {
    const columns = {
        'rating': 0,
        'name': 1,
        'industry': 2,
        'stage': 3
    };
    return columns[column];
}

function filterCompanies(query) {
    const rows = document.querySelectorAll('#companiesTableBody tr');
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(query) ? '' : 'none';
    });
}

function savePreferences() {
    const preferences = {
        categories: {},
        additional: document.getElementById('additionalPrefs').value
    };

    document.querySelectorAll('.custom-select').forEach(select => {
        const category = select.closest('.custom-select-container').querySelector('.preference-label').textContent;
        const selectedOptions = Array.from(select.querySelectorAll('input:checked'))
            .map(input => input.value);
        preferences.categories[category] = selectedOptions;
    });
    
    console.log('Saved preferences:', preferences);
    
    const toast = document.createElement('div');
    toast.className = 'toast success';
    toast.textContent = 'Preferences saved successfully';
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}

function resetPreferences() {
    document.querySelectorAll('.custom-select').forEach(select => {
        const selectedText = select.querySelector('.selected-text');
        const options = select.querySelectorAll('input');
        
        options.forEach(option => option.checked = false);
        selectedText.textContent = select.dataset.placeholder;
    });

    const textarea = document.getElementById('additionalPrefs');
    textarea.value = '';
    textarea.style.height = 'auto';
}

function openModal() {
    document.getElementById('addCompanyModal').style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

function closeModal() {
    document.getElementById('addCompanyModal').style.display = 'none';
    document.body.style.overflow = 'auto';
}

window.onclick = function(event) {
    if (event.target.classList.contains('modal')) {
        closeModal();
    }
}
</script>
{% endblock %}
